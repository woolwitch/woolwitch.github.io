version: '3'

vars:
  PROJECT_NAME: wool-witch
  NODE_VERSION: '>=18.0.0'

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  install:
    desc: Install project dependencies
    cmds:
      - npm install
    sources:
      - package.json
      - package-lock.json
    generates:
      - node_modules/**/*

  # Local Development with Supabase
  dev:local:
    desc: Start development server with local Supabase (Docker required)
    deps: [install, db:start]
    cmds:
      - echo "ðŸš€ Starting development server..."
      - echo "ðŸ“Š Supabase Studio: http://localhost:54323"
      - echo "ðŸ”Œ API: http://localhost:54321"
      - npm run dev

  dev:
    desc: Start development server with hot reload (requires .env with Supabase credentials)
    deps: [install]
    cmds:
      - npm run dev

  # Database Management (Local Supabase with Docker)
  db:start:
    desc: Start local Supabase database with Docker
    cmds:
      - |
        if ! command -v supabase &> /dev/null; then
          echo "âŒ Supabase CLI not found!"
          echo "ðŸ“¦ Installing Supabase CLI..."
          echo "   Run: npm install -g supabase"
          echo "   Or visit: https://supabase.com/docs/guides/cli"
          exit 1
        fi
      - echo "ðŸ³ Starting Supabase local development environment..."
      - supabase start
      - echo "âœ… Supabase is running!"
      - echo "ðŸ“Š Studio: http://localhost:54323"
      - echo "ðŸ”Œ API: http://localhost:54321"
      - echo "ðŸ“§ Inbucket: http://localhost:54324"

  db:stop:
    desc: Stop local Supabase database
    cmds:
      - echo "ðŸ›‘ Stopping Supabase..."
      - supabase stop
      - echo "âœ… Supabase stopped"

  db:reset:
    desc: Reset local database (destroys all data)
    cmds:
      - echo "âš ï¸  Resetting database (this will delete all local data)..."
      - supabase db reset
      - echo "âœ… Database reset complete"

  db:status:
    desc: Check status of local Supabase
    cmds:
      - supabase status

  db:migration:new:
    desc: Create a new database migration
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "âŒ Please provide a migration name"
          echo "Usage: task db:migration:new -- migration_name"
          exit 1
        fi
      - supabase migration new {{.CLI_ARGS}}

  build:
    desc: Build the project for production
    deps: [install]
    cmds:
      - npm run build
    sources:
      - src/**/*
      - index.html
      - vite.config.ts
      - tsconfig*.json
    generates:
      - dist/**/*

  lint:
    desc: Run ESLint to check code quality
    deps: [install]
    cmds:
      - npm run lint

  lint:fix:
    desc: Run ESLint and automatically fix issues
    deps: [install]
    cmds:
      - npm run lint -- --fix

  typecheck:
    desc: Run TypeScript type checking
    deps: [install]
    cmds:
      - npm run typecheck

  preview:
    desc: Preview production build locally
    deps: [build]
    cmds:
      - npm run preview

  clean:
    desc: Remove build artifacts and dependencies
    cmds:
      - rm -rf dist || true
      - rm -rf node_modules || true
      - rm -rf .vite || true
      - echo "âœ… Cleaned build artifacts and dependencies"

  clean:dist:
    desc: Remove only build artifacts (keeps node_modules)
    cmds:
      - rm -rf dist || true
      - rm -rf .vite || true
      - echo "âœ… Cleaned build artifacts"

  clean:db:
    desc: Remove local Supabase Docker volumes (complete cleanup)
    cmds:
      - supabase stop --no-backup || true
      - |
        volumes=$(docker volume ls -q | grep supabase || true)
        if [ -n "$volumes" ]; then
          echo "$volumes" | xargs docker volume rm
        fi
      - echo "âœ… Cleaned all Supabase data"

  setup:
    desc: Complete first-time project setup
    cmds:
      - task: check-deps
      - task: install
      - task: setup-env
      - echo ""
      - echo "âœ… Setup complete!"
      - echo ""
      - echo "ðŸš€ Quick Start Options:"
      - echo ""
      - echo "Option 1 - Local Development (Recommended):"
      - echo "  task dev:local     # Starts local Supabase + dev server"
      - echo ""
      - echo "Option 2 - Cloud Supabase:"
      - echo "  1. Copy .env.local to .env"
      - echo "  2. Add your Supabase credentials to .env"
      - echo "  3. task dev"
      - echo ""

  check-deps:
    desc: Check if required tools are installed
    cmds:
      - |
        echo "ðŸ” Checking dependencies..."
        
        # Check Node.js
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js not found! Please install Node.js >= 18.0.0"
          exit 1
        fi
        echo "âœ… Node.js $(node --version)"
        
        # Check npm
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm not found!"
          exit 1
        fi
        echo "âœ… npm $(npm --version)"
        
        # Check Docker
        if ! command -v docker &> /dev/null; then
          echo "âš ï¸  Docker not found (required for local database)"
          echo "   Install from: https://docs.docker.com/get-docker/"
        else
          echo "âœ… Docker $(docker --version | cut -d' ' -f3)"
        fi
        
        # Check Supabase CLI
        if ! command -v supabase &> /dev/null; then
          echo "âš ï¸  Supabase CLI not found (required for local database)"
          echo "   Install: npm install -g supabase"
        else
          echo "âœ… Supabase CLI $(supabase --version)"
        fi

  setup-env:
    desc: Set up environment files
    cmds:
      - |
        if [ ! -f .env.local ]; then
          echo "ðŸ“ Creating .env.local for local development..."
          cat > .env.local <<EOF
        # Local Development Environment Variables (Supabase Local)
        # These are used when running Supabase locally with Docker
        
        # Local Supabase API URL (provided by Supabase CLI)
        VITE_SUPABASE_URL=http://localhost:54321
        
        # Local Supabase Anonymous Key (default for local development)
        # WARNING: This is the standard Supabase local development key.
        # NEVER use this in production! It's only safe for local development.
        VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
        EOF
          echo "âœ… Created .env.local"
        else
          echo "âœ… .env.local already exists"
        fi
        
        if [ ! -f .env.example ]; then
          echo "ðŸ“ Creating .env.example..."
          cat > .env.example <<EOF
        # Supabase Configuration (for cloud deployment)
        # Get these values from your Supabase project settings
        # https://app.supabase.com/project/_/settings/api
        
        VITE_SUPABASE_URL=your_supabase_url_here
        VITE_SUPABASE_ANON_KEY=your_supabase_anon_key_here
        EOF
          echo "âœ… Created .env.example"
        else
          echo "âœ… .env.example already exists"
        fi

  check-env:
    desc: Check if required environment variables are set
    cmds:
      - |
        if [ ! -f .env ] && [ ! -f .env.local ]; then
          echo "âš ï¸  No environment file found (.env or .env.local)"
          echo ""
          echo "For local development:"
          echo "  .env.local is automatically created with 'task setup'"
          echo ""
          echo "For cloud Supabase:"
          echo "  Copy .env.example to .env and fill in your credentials"
          exit 1
        else
          echo "âœ… Environment file exists"
        fi
    silent: true

  test:
    desc: Run all quality checks (lint, typecheck)
    deps: [install]
    cmds:
      - task: lint
      - task: typecheck
      - echo "âœ… All checks passed!"

  ci:
    desc: Run all CI checks (used in continuous integration)
    cmds:
      - task: install
      - task: test
      - task: build
